#!/usr/bin/env bash

set -e -u

# shellcheck source=admin/lib/common.inc.bash
source "$(dirname "${BASH_SOURCE[0]}")/lib/common.inc.bash"

ENV_FILE="$MB_DOCKER_ROOT/.env"

if [ ! -f "$ENV_FILE" ]; then
  echo >&2 "Missing .env. Run: admin/first-run"
  exit 1
fi

# shellcheck disable=SC1090
source "$ENV_FILE"

ok=1

is_true() {
  case "${1:-}" in
    1|true|TRUE|yes|YES|on|ON) return 0 ;;
    *) return 1 ;;
  esac
}

if is_true "${MUSICBRAINZ_REPLICATION_ENABLED:-0}"; then
  if [ -z "${MUSICBRAINZ_REPLICATION_TOKEN:-}" ]; then
    echo >&2 "Replication enabled but MUSICBRAINZ_REPLICATION_TOKEN is empty."
    ok=0
  elif [ ${#MUSICBRAINZ_REPLICATION_TOKEN} -ne 40 ]; then
    echo >&2 "MUSICBRAINZ_REPLICATION_TOKEN must be 40 characters (got ${#MUSICBRAINZ_REPLICATION_TOKEN})."
    ok=0
  fi

  time_val="${MUSICBRAINZ_REPLICATION_TIME:-03:00}"
  if [[ ! "$time_val" =~ ^([01][0-9]|2[0-3]):[0-5][0-9]$ ]]; then
    echo >&2 "MUSICBRAINZ_REPLICATION_TIME must be HH:MM 24hr (got '$time_val')."
    ok=0
  fi
fi

if [ "$ok" -ne 1 ]; then
  exit 1
fi

echo "OK: .env looks valid."
