#!/usr/bin/env bash

set -e -u

# shellcheck source=admin/lib/common.inc.bash
source "$(dirname "${BASH_SOURCE[0]}")/lib/common.inc.bash"

ENV_FILE="$MB_DOCKER_ROOT/.env"

if [ ! -f "$ENV_FILE" ]; then
  echo >&2 "Missing .env. Run: admin/first-run"
  exit 1
fi

# shellcheck disable=SC1090
source "$ENV_FILE"

ok=1

is_true() {
  case "${1:-}" in
    1|true|TRUE|yes|YES|on|ON) return 0 ;;
    *) return 1 ;;
  esac
}

is_ipv4() {
  [[ "${1:-}" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]
}

is_cidr() {
  [[ "${1:-}" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$ ]]
}

if is_true "${MUSICBRAINZ_REPLICATION_ENABLED:-0}"; then
  if [ -z "${MUSICBRAINZ_REPLICATION_TOKEN:-}" ]; then
    echo >&2 "Replication enabled but MUSICBRAINZ_REPLICATION_TOKEN is empty."
    ok=0
  elif [ ${#MUSICBRAINZ_REPLICATION_TOKEN} -ne 40 ]; then
    echo >&2 "MUSICBRAINZ_REPLICATION_TOKEN must be 40 characters (got ${#MUSICBRAINZ_REPLICATION_TOKEN})."
    ok=0
  fi

  time_val="${MUSICBRAINZ_REPLICATION_TIME:-03:00}"
  if [[ ! "$time_val" =~ ^([01][0-9]|2[0-3]):[0-5][0-9]$ ]]; then
    echo >&2 "MUSICBRAINZ_REPLICATION_TIME must be HH:MM 24hr (got '$time_val')."
    ok=0
  fi
fi


# Indexing schedule validation
if is_true "${MUSICBRAINZ_INDEXING_ENABLED:-0}"; then
  time_val="${MUSICBRAINZ_INDEXING_TIME:-01:00}"
  if [[ ! "$time_val" =~ ^([01][0-9]|2[0-3]):[0-5][0-9]$ ]]; then
    echo >&2 "MUSICBRAINZ_INDEXING_TIME must be HH:MM 24hr (got '$time_val')."
    ok=0
  fi

  freq_val="${MUSICBRAINZ_INDEXING_FREQUENCY:-weekly}"
  freq_val="${freq_val,,}"
  case "$freq_val" in
    daily|weekly|biweekly) ;;
    *)
      echo >&2 "MUSICBRAINZ_INDEXING_FREQUENCY must be daily, weekly, or biweekly (got '$freq_val')."
      ok=0
      ;;
  esac

  if [ "$freq_val" != "daily" ]; then
    day_val="${MUSICBRAINZ_INDEXING_DAY:-Sunday}"
    day_val_lc="${day_val,,}"
    case "$day_val_lc" in
      sun|sunday|mon|monday|tue|tues|tuesday|wed|wednesday|thu|thur|thurs|thursday|fri|friday|sat|saturday) ;;
      *)
        echo >&2 "MUSICBRAINZ_INDEXING_DAY must be a valid English day name (got '$day_val')."
        ok=0
        ;;
    esac
  fi
fi

# Network configuration validation
network_type="${MUSICBRAINZ_NETWORK_TYPE:-bridge}"
network_type="${network_type,,}"

case "$network_type" in
  ""|bridge)
    if [ -n "${MUSICBRAINZ_NETWORK_PARENT:-}" ] \
      || [ -n "${MUSICBRAINZ_NETWORK_SUBNET:-}" ] \
      || [ -n "${MUSICBRAINZ_NETWORK_GATEWAY:-}" ] \
      || [ -n "${MUSICBRAINZ_NETWORK_IP_RANGE:-}" ] \
      || [ -n "${MUSICBRAINZ_NETWORK_IP:-}" ] \
      || [ -n "${MUSICBRAINZ_IPVLAN_MODE:-}" ] \
      || [ -n "${LIMBO_NETWORK_IP:-}" ]; then
      echo >&2 "Network values are set but MUSICBRAINZ_NETWORK_TYPE is bridge."
      echo >&2 "Clear them or set MUSICBRAINZ_NETWORK_TYPE to macvlan or ipvlan."
      ok=0
    fi
    ;;
  macvlan|ipvlan)
    if [ -z "${COMPOSE_FILE:-}" ] || [[ "${COMPOSE_FILE:-}" != *"default/network.override.yml"* ]]; then
      echo >&2 "COMPOSE_FILE must include default/network.override.yml when MUSICBRAINZ_NETWORK_TYPE is '$network_type'."
      ok=0
    fi

    if [ -z "${MUSICBRAINZ_NETWORK_PARENT:-}" ]; then
      echo >&2 "MUSICBRAINZ_NETWORK_PARENT is required for $network_type."
      ok=0
    fi

    if [ -z "${MUSICBRAINZ_NETWORK_SUBNET:-}" ]; then
      echo >&2 "MUSICBRAINZ_NETWORK_SUBNET is required for $network_type."
      ok=0
    elif ! is_cidr "${MUSICBRAINZ_NETWORK_SUBNET:-}"; then
      echo >&2 "MUSICBRAINZ_NETWORK_SUBNET must be CIDR (got '${MUSICBRAINZ_NETWORK_SUBNET:-}')."
      ok=0
    fi

    if [ -z "${MUSICBRAINZ_NETWORK_GATEWAY:-}" ]; then
      echo >&2 "MUSICBRAINZ_NETWORK_GATEWAY is required for $network_type."
      ok=0
    elif ! is_ipv4 "${MUSICBRAINZ_NETWORK_GATEWAY:-}"; then
      echo >&2 "MUSICBRAINZ_NETWORK_GATEWAY must be an IPv4 address (got '${MUSICBRAINZ_NETWORK_GATEWAY:-}')."
      ok=0
    fi

    if [ -n "${MUSICBRAINZ_NETWORK_IP_RANGE:-}" ] && ! is_cidr "${MUSICBRAINZ_NETWORK_IP_RANGE:-}"; then
      echo >&2 "MUSICBRAINZ_NETWORK_IP_RANGE must be CIDR (got '${MUSICBRAINZ_NETWORK_IP_RANGE:-}')."
      ok=0
    fi

    if [ -n "${MUSICBRAINZ_NETWORK_IP:-}" ] && ! is_ipv4 "${MUSICBRAINZ_NETWORK_IP:-}"; then
      echo >&2 "MUSICBRAINZ_NETWORK_IP must be an IPv4 address (got '${MUSICBRAINZ_NETWORK_IP:-}')."
      ok=0
    fi

    if [ -n "${LIMBO_NETWORK_IP:-}" ] && ! is_ipv4 "${LIMBO_NETWORK_IP:-}"; then
      echo >&2 "LIMBO_NETWORK_IP must be an IPv4 address (got '${LIMBO_NETWORK_IP:-}')."
      ok=0
    fi

    if [ "$network_type" = "ipvlan" ] && [ -n "${MUSICBRAINZ_IPVLAN_MODE:-}" ]; then
      mode="${MUSICBRAINZ_IPVLAN_MODE,,}"
      case "$mode" in
        l2|l3) ;;
        *)
          echo >&2 "MUSICBRAINZ_IPVLAN_MODE must be l2 or l3 (got '${MUSICBRAINZ_IPVLAN_MODE:-}')."
          ok=0
          ;;
      esac
    elif [ -n "${MUSICBRAINZ_IPVLAN_MODE:-}" ]; then
      echo >&2 "MUSICBRAINZ_IPVLAN_MODE is only valid when MUSICBRAINZ_NETWORK_TYPE=ipvlan."
      ok=0
    fi
    ;;
  *)
    echo >&2 "MUSICBRAINZ_NETWORK_TYPE must be bridge, macvlan, or ipvlan (got '$network_type')."
    ok=0
    ;;
esac
if [ "$ok" -ne 1 ]; then
  exit 1
fi

echo "OK: .env looks valid."
