name: Publish Images

on:
  push:
    branches:
      - master
    paths:
      - build/**
      - compose/**
      - docker-compose.yml
      - .env
      - .env.example
      - .github/workflows/publish-images.yml
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  publish-ghcr:
    name: Publish to GHCR
    runs-on: ubuntu-latest
    env:
      IMAGE_NAMESPACE: ghcr.io/${{ github.repository }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: db
            context: build/postgres-prebuilt
            dockerfile: build/postgres-prebuilt/Dockerfile
          - name: musicbrainz
            context: build/musicbrainz-prebuilt
            dockerfile: build/musicbrainz-prebuilt/Dockerfile
          - name: bootstrap
            context: build/bootstrap
            dockerfile: build/bootstrap/Dockerfile
          - name: search
            context: build/solr
            dockerfile: build/solr/Dockerfile
          - name: indexer
            context: build/sir
            dockerfile: build/sir/Dockerfile
          - name: mq
            context: build/rabbitmq
            dockerfile: build/rabbitmq/Dockerfile
    steps:
      - uses: actions/checkout@v4

      - name: Load build vars
      # shellcheck disable=SC1091
        run: |
          set -e
          REPO_LC=$(echo "$GITHUB_REPOSITORY" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAMESPACE=ghcr.io/${REPO_LC}" >> "$GITHUB_ENV"

          source .env

          echo "POSTGRES_VERSION=$POSTGRES_VERSION" >> "$GITHUB_ENV"
          echo "MB_SOLR_VERSION=$MB_SOLR_VERSION" >> "$GITHUB_ENV"
          echo "MUSICBRAINZ_SERVER_VERSION=$MUSICBRAINZ_SERVER_VERSION" >> "$GITHUB_ENV"
          echo "MUSICBRAINZ_BUILD_SEQUENCE=$MUSICBRAINZ_BUILD_SEQUENCE" >> "$GITHUB_ENV"

          DB_BUILD_SEQUENCE=$(sed -n 's/^ARG DB_BUILD_SEQUENCE=//p' build/postgres-prebuilt/Dockerfile)
          echo "DB_BUILD_SEQUENCE=${DB_BUILD_SEQUENCE:-0}" >> "$GITHUB_ENV"

          SIR_VERSION=$(sed -n 's/^ARG SIR_VERSION=//p' build/sir/Dockerfile)
          PYTHON_VERSION=$(sed -n 's/^ARG PYTHON_VERSION=//p' build/sir/Dockerfile)
          BASE_IMAGE_DATE=$(sed -n 's/^ARG BASE_IMAGE_DATE=//p' build/sir/Dockerfile)
          echo "SIR_VERSION=$SIR_VERSION" >> "$GITHUB_ENV"
          echo "PYTHON_VERSION=$PYTHON_VERSION" >> "$GITHUB_ENV"
          echo "BASE_IMAGE_DATE=$BASE_IMAGE_DATE" >> "$GITHUB_ENV"

          RABBITMQ_VERSION=$(sed -n 's/^ARG RABBITMQ_VERSION=//p' build/rabbitmq/Dockerfile)
          RABBITMQ_VARIANT=$(sed -n 's/^ARG RABBITMQ_VARIANT=//p' build/rabbitmq/Dockerfile)
          RABBITMQ_TAG="${RABBITMQ_VERSION}${RABBITMQ_VARIANT}"
          echo "RABBITMQ_VERSION=$RABBITMQ_VERSION" >> "$GITHUB_ENV"
          echo "RABBITMQ_VARIANT=$RABBITMQ_VARIANT" >> "$GITHUB_ENV"
          echo "RABBITMQ_TAG=$RABBITMQ_TAG" >> "$GITHUB_ENV"

          SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
          echo "SHORT_SHA=$SHORT_SHA" >> "$GITHUB_ENV"

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute tags and build args
        run: |
          set -e
          BUILD_ARGS=""
          case "${{ matrix.name }}" in
            db)
              VERSION="$POSTGRES_VERSION"
              BUILD_ARGS=$'POSTGRES_VERSION='"$POSTGRES_VERSION"$'\nDB_BUILD_SEQUENCE='"$DB_BUILD_SEQUENCE"
              ;;
            musicbrainz)
              VERSION="${MUSICBRAINZ_SERVER_VERSION}-build${MUSICBRAINZ_BUILD_SEQUENCE}"
              BUILD_ARGS=$'MUSICBRAINZ_SERVER_VERSION='"$MUSICBRAINZ_SERVER_VERSION"$'\nMUSICBRAINZ_BUILD_SEQUENCE='"$MUSICBRAINZ_BUILD_SEQUENCE"
              ;;
            bootstrap)
              VERSION="${MUSICBRAINZ_SERVER_VERSION}-build${MUSICBRAINZ_BUILD_SEQUENCE}"
              BUILD_ARGS=$'MUSICBRAINZ_SERVER_VERSION='"$MUSICBRAINZ_SERVER_VERSION"$'\nMUSICBRAINZ_BUILD_SEQUENCE='"$MUSICBRAINZ_BUILD_SEQUENCE"
              ;;
            search)
              VERSION="$MB_SOLR_VERSION"
              BUILD_ARGS=$'MB_SOLR_VERSION='"$MB_SOLR_VERSION"
              ;;
            indexer)
              VERSION="$SIR_VERSION"
              BUILD_ARGS=$'SIR_VERSION='"$SIR_VERSION"$'\nPYTHON_VERSION='"$PYTHON_VERSION"$'\nBASE_IMAGE_DATE='"$BASE_IMAGE_DATE"
              ;;
            mq)
              VERSION="$RABBITMQ_TAG"
              BUILD_ARGS=$'RABBITMQ_VERSION='"$RABBITMQ_VERSION"$'\nRABBITMQ_VARIANT='"$RABBITMQ_VARIANT"$'\nRABBITMQ_TAG='"$RABBITMQ_TAG"
              ;;
            *)
              echo "Unknown image: ${{ matrix.name }}" >&2
              exit 1
              ;;
          esac

          TAGS="$IMAGE_NAMESPACE/${{ matrix.name }}:$VERSION"
          TAGS="$TAGS"$'\n'"$IMAGE_NAMESPACE/${{ matrix.name }}:sha-$SHORT_SHA"

          printf "TAGS<<EOF\n%s\nEOF\n" "$TAGS" >> "$GITHUB_ENV"
          printf "BUILD_ARGS<<EOF\n%s\nEOF\n" "$BUILD_ARGS" >> "$GITHUB_ENV"

      - name: Build and push images
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          platforms: linux/amd64
          tags: ${{ env.TAGS }}
          build-args: ${{ env.BUILD_ARGS }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Compute Docker Hub description
        run: |
          set -e
          case "${{ matrix.name }}" in
            db)
              SHORT_DESC="PostgreSQL database for MBMS_PLUS - MusicBrainz Mirror Server PLUS + Lidarr API Bridge."
              README_FILE=".github/dockerhub/README-db.md"
              ;;
            musicbrainz)
              SHORT_DESC="MusicBrainz web server for MBMS_PLUS - MusicBrainz Mirror Server PLUS + Lidarr API Bridge."
              README_FILE=".github/dockerhub/README-musicbrainz.md"
              ;;
            bootstrap)
              SHORT_DESC="Bootstrap helper for MBMS_PLUS - imports dumps, materialized tables, and indexes."
              README_FILE=".github/dockerhub/README-bootstrap.md"
              ;;
            search)
              SHORT_DESC="Solr search for MBMS_PLUS - MusicBrainz Mirror Server PLUS + Lidarr API Bridge."
              README_FILE=".github/dockerhub/README-search.md"
              ;;
            indexer)
              SHORT_DESC="SIR indexer for MBMS_PLUS - MusicBrainz Mirror Server PLUS + Lidarr API Bridge."
              README_FILE=".github/dockerhub/README-indexer.md"
              ;;
            mq)
              SHORT_DESC="RabbitMQ broker for MBMS_PLUS - MusicBrainz Mirror Server PLUS + Lidarr API Bridge."
              README_FILE=".github/dockerhub/README-mq.md"
              ;;
            *)
              echo "Unknown image: ${{ matrix.name }}" >&2
              exit 1
              ;;
          esac

          echo "DOCKERHUB_REPO=${IMAGE_REPO_PREFIX}-${{ matrix.name }}" >> "$GITHUB_ENV"
          echo "SHORT_DESC=$SHORT_DESC" >> "$GITHUB_ENV"
          echo "README_FILE=$README_FILE" >> "$GITHUB_ENV"

      - name: Update Docker Hub description
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN_MBMS }}
          repository: ${{ env.IMAGE_NAMESPACE }}/${{ env.DOCKERHUB_REPO }}
          short-description: ${{ env.SHORT_DESC }}
          readme-filepath: ${{ env.README_FILE }}

  publish-dockerhub:
    name: Publish to Docker Hub
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN_MBMS: ${{ secrets.DOCKERHUB_TOKEN_MBMS }}
      IMAGE_REGISTRY: docker.io
      IMAGE_REPO_PREFIX: mbms-plus
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: db
            context: build/postgres-prebuilt
            dockerfile: build/postgres-prebuilt/Dockerfile
          - name: musicbrainz
            context: build/musicbrainz-prebuilt
            dockerfile: build/musicbrainz-prebuilt/Dockerfile
          - name: bootstrap
            context: build/bootstrap
            dockerfile: build/bootstrap/Dockerfile
          - name: search
            context: build/solr
            dockerfile: build/solr/Dockerfile
          - name: indexer
            context: build/sir
            dockerfile: build/sir/Dockerfile
          - name: mq
            context: build/rabbitmq
            dockerfile: build/rabbitmq/Dockerfile
    steps:
      - uses: actions/checkout@v4

      - name: Load build vars
      # shellcheck disable=SC1091
        run: |
          set -e
          USER_LC=$(echo "$DOCKERHUB_USERNAME" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAMESPACE=${USER_LC}" >> "$GITHUB_ENV"

          source .env

          MBMS_VERSION=$(cat VERSION)
          echo "MBMS_VERSION=$MBMS_VERSION" >> "$GITHUB_ENV"

          echo "POSTGRES_VERSION=$POSTGRES_VERSION" >> "$GITHUB_ENV"
          echo "MB_SOLR_VERSION=$MB_SOLR_VERSION" >> "$GITHUB_ENV"
          echo "MUSICBRAINZ_SERVER_VERSION=$MUSICBRAINZ_SERVER_VERSION" >> "$GITHUB_ENV"
          echo "MUSICBRAINZ_BUILD_SEQUENCE=$MUSICBRAINZ_BUILD_SEQUENCE" >> "$GITHUB_ENV"

          DB_BUILD_SEQUENCE=$(sed -n 's/^ARG DB_BUILD_SEQUENCE=//p' build/postgres-prebuilt/Dockerfile)
          echo "DB_BUILD_SEQUENCE=${DB_BUILD_SEQUENCE:-0}" >> "$GITHUB_ENV"

          SIR_VERSION=$(sed -n 's/^ARG SIR_VERSION=//p' build/sir/Dockerfile)
          PYTHON_VERSION=$(sed -n 's/^ARG PYTHON_VERSION=//p' build/sir/Dockerfile)
          BASE_IMAGE_DATE=$(sed -n 's/^ARG BASE_IMAGE_DATE=//p' build/sir/Dockerfile)
          echo "SIR_VERSION=$SIR_VERSION" >> "$GITHUB_ENV"
          echo "PYTHON_VERSION=$PYTHON_VERSION" >> "$GITHUB_ENV"
          echo "BASE_IMAGE_DATE=$BASE_IMAGE_DATE" >> "$GITHUB_ENV"

          RABBITMQ_VERSION=$(sed -n 's/^ARG RABBITMQ_VERSION=//p' build/rabbitmq/Dockerfile)
          RABBITMQ_VARIANT=$(sed -n 's/^ARG RABBITMQ_VARIANT=//p' build/rabbitmq/Dockerfile)
          RABBITMQ_TAG="${RABBITMQ_VERSION}${RABBITMQ_VARIANT}"
          echo "RABBITMQ_VERSION=$RABBITMQ_VERSION" >> "$GITHUB_ENV"
          echo "RABBITMQ_VARIANT=$RABBITMQ_VARIANT" >> "$GITHUB_ENV"
          echo "RABBITMQ_TAG=$RABBITMQ_TAG" >> "$GITHUB_ENV"

          SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
          echo "SHORT_SHA=$SHORT_SHA" >> "$GITHUB_ENV"

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN_MBMS }}

      - name: Compute tags and build args
        run: |
          set -e
          BUILD_ARGS=""
          case "${{ matrix.name }}" in
            db)
              VERSION="$POSTGRES_VERSION"
              BUILD_ARGS=$'POSTGRES_VERSION='"$POSTGRES_VERSION"$'\nDB_BUILD_SEQUENCE='"$DB_BUILD_SEQUENCE"
              ;;
            musicbrainz)
              VERSION="${MUSICBRAINZ_SERVER_VERSION}-build${MUSICBRAINZ_BUILD_SEQUENCE}"
              BUILD_ARGS=$'MUSICBRAINZ_SERVER_VERSION='"$MUSICBRAINZ_SERVER_VERSION"$'\nMUSICBRAINZ_BUILD_SEQUENCE='"$MUSICBRAINZ_BUILD_SEQUENCE"
              ;;
            bootstrap)
              VERSION="${MUSICBRAINZ_SERVER_VERSION}-build${MUSICBRAINZ_BUILD_SEQUENCE}"
              BUILD_ARGS=$'MUSICBRAINZ_SERVER_VERSION='"$MUSICBRAINZ_SERVER_VERSION"$'\nMUSICBRAINZ_BUILD_SEQUENCE='"$MUSICBRAINZ_BUILD_SEQUENCE"
              ;;
            search)
              VERSION="$MB_SOLR_VERSION"
              BUILD_ARGS=$'MB_SOLR_VERSION='"$MB_SOLR_VERSION"
              ;;
            indexer)
              VERSION="$SIR_VERSION"
              BUILD_ARGS=$'SIR_VERSION='"$SIR_VERSION"$'\nPYTHON_VERSION='"$PYTHON_VERSION"$'\nBASE_IMAGE_DATE='"$BASE_IMAGE_DATE"
              ;;
            mq)
              VERSION="$RABBITMQ_TAG"
              BUILD_ARGS=$'RABBITMQ_VERSION='"$RABBITMQ_VERSION"$'\nRABBITMQ_VARIANT='"$RABBITMQ_VARIANT"$'\nRABBITMQ_TAG='"$RABBITMQ_TAG"
              ;;
            *)
              echo "Unknown image: ${{ matrix.name }}" >&2
              exit 1
              ;;
          esac

          TAGS="$IMAGE_REGISTRY/$IMAGE_NAMESPACE/${IMAGE_REPO_PREFIX}-${{ matrix.name }}:$MBMS_VERSION"

          printf "TAGS<<EOF\n%s\nEOF\n" "$TAGS" >> "$GITHUB_ENV"
          printf "BUILD_ARGS<<EOF\n%s\nEOF\n" "$BUILD_ARGS" >> "$GITHUB_ENV"

      - name: Build and push images
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          platforms: linux/amd64
          tags: ${{ env.TAGS }}
          build-args: ${{ env.BUILD_ARGS }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  publish-deploy:
    name: Publish Deploy Repo
    runs-on: ubuntu-latest
    env:
      MBMS_TOKEN: ${{ secrets.MBMS_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Load deploy vars
      # shellcheck disable=SC1091
        run: |
          set -e
          MBMS_VERSION=$(cat VERSION)
          echo "MBMS_VERSION=$MBMS_VERSION" >> "$GITHUB_ENV"
          SIR_VERSION=$(sed -n 's/^ARG SIR_VERSION=//p' build/sir/Dockerfile)
          RABBITMQ_VERSION=$(sed -n 's/^ARG RABBITMQ_VERSION=//p' build/rabbitmq/Dockerfile)
          RABBITMQ_VARIANT=$(sed -n 's/^ARG RABBITMQ_VARIANT=//p' build/rabbitmq/Dockerfile)
          RABBITMQ_TAG="${RABBITMQ_VERSION}${RABBITMQ_VARIANT}"
          echo "SIR_VERSION=$SIR_VERSION" >> "$GITHUB_ENV"
          echo "RABBITMQ_TAG=$RABBITMQ_TAG" >> "$GITHUB_ENV"

      - name: Checkout deploy repo
        uses: actions/checkout@v4
        with:
          repository: HVR88/MBMS_PLUS
          token: ${{ secrets.MBMS_TOKEN }}
          path: deploy

      - name: Stage deploy files
        run: |
          set -e
          rm -rf deploy-out
          mkdir -p deploy-out/compose deploy-out/default deploy-out/local deploy-out/build/solr/scripts

          cp docker-compose.yml deploy-out/
          cp deploy-assets/README.md deploy-out/README.md
          cp VERSION deploy-out/
          cp compose/bootstrap.yml compose/indexing-cron.yml compose/lm-bridge.yml compose/dockerhub-images.yml deploy-out/compose/
          cp default/postgres.env default/indexer.ini deploy-out/default/
          if [ -f local/network.override.yml ]; then
            cp local/network.override.yml deploy-out/local/
          else
            printf '%s\n' \
              '# Description: Network override (generated)' \
              'networks:' \
              '  default:' \
              '    driver: bridge' \
              > deploy-out/local/network.override.yml
          fi
          cp build/solr/scripts/bootstrap-indexes.sh deploy-out/build/solr/scripts/
          cp .env deploy-out/.env

          python3 - <<'PY'
          from __future__ import annotations

          import os
          from pathlib import Path

          env_path = Path("deploy-out/.env")
          text = env_path.read_text()
          lines = text.splitlines()

          def upsert(lines: list[str], key: str, value: str) -> list[str]:
            out: list[str] = []
            found = False
            prefix = f"{key}="
            for line in lines:
              if line.startswith(prefix):
                out.append(prefix + value)
                found = True
              else:
                out.append(line)
            if not found:
              out.append(prefix + value)
            return out

          def update_compose_file(lines: list[str]) -> list[str]:
            out: list[str] = []
            found = False
            for line in lines:
              if line.startswith("COMPOSE_FILE="):
                found = True
                value = line.split("=", 1)[1]
                if "compose/dockerhub-images.yml" not in value:
                  value = value + ":compose/dockerhub-images.yml"
                out.append("COMPOSE_FILE=" + value)
              else:
                out.append(line)
            if not found:
              out.insert(0, "COMPOSE_FILE=docker-compose.yml:compose/bootstrap.yml:compose/indexing-cron.yml:compose/lm-bridge.yml:local/network.override.yml:compose/dockerhub-images.yml")
            return out

          lines = update_compose_file(lines)
          lines = upsert(lines, "MBMS_VERSION", os.environ["MBMS_VERSION"])
          lines = upsert(lines, "MBMS_DOCKERHUB_NAMESPACE", "espressomatic")
          lines = upsert(lines, "MBMS_DOCKERHUB_REPO_PREFIX", "mbms-plus")
          lines = upsert(lines, "SIR_VERSION", os.environ["SIR_VERSION"])
          lines = upsert(lines, "RABBITMQ_TAG", os.environ["RABBITMQ_TAG"])

          env_path.write_text("\n".join(lines).rstrip() + "\n")
          PY

      - name: Sync deploy repo
        run: |
          set -e
          rsync -a --delete --exclude .git deploy-out/ deploy/

      - name: Commit and push
        working-directory: deploy
        run: |
          set -e
          if [ -z "$(git status --porcelain)" ]; then
            echo "No deploy changes to publish."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Publish deploy files from ${GITHUB_REPOSITORY}@${GITHUB_SHA}"
          git push
