name: Bump Version

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  bump-version:
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Bump VERSION
        run: |
          set -e
          if [ ! -f VERSION ]; then
            echo "VERSION file not found." >&2
            exit 1
          fi

          python3 - <<'PY'
          import re
          from pathlib import Path

          path = Path('VERSION')
          version = path.read_text().strip()
          m = re.fullmatch(r'(\d+)\.(\d+)\.(\d+)\.(\d{1,3})', version)
          if not m:
            raise SystemExit(f"VERSION format invalid: {version!r}")

          major, minor, patch, build = map(int, m.groups())
          build += 1
          if build > 999:
            patch += 1
            build = 0
          new_version = f"{major}.{minor}.{patch}.{build}"
          path.write_text(new_version + "\n")
          print(new_version)
          PY

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add VERSION
          if git diff --cached --quiet; then
            echo "No version change to commit."
            exit 0
          fi
          NEW_VERSION=$(cat VERSION)
          git commit -m "Bump version to ${NEW_VERSION}"
          git push
